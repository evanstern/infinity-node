# Traefik Dynamic Configuration for VM 100 (emby)
# This file contains routing rules for all services on VM 100
# Update this file to add/remove/modify service routes

http:
  # Routers define how requests are matched and routed
  routers:
    # Emby External - routed through Pangolin until final cutover, but Traefik needs full chain + rate limits
    emby-external:
      rule: "Host(`emby.infinity-node.com`)"
      entryPoints:
        - web
      service: emby
      middlewares:
        - emby-security-headers
        - emby-rate-limit

    # Emby Internal - LAN-only hostname
    emby-internal:
      rule: "Host(`emby.local.infinity-node.win`)"
      entryPoints:
        - web
      service: emby
      middlewares:
        - emby-security-headers

    # Portainer - Container management
    portainer-100:
      rule: "Host(`portainer-100.local.infinity-node.win`)"
      entryPoints:
        - web
      service: portainer-100

  # Services define the backend servers to route to
  services:
    # Emby - Internal port 8096 (host network mode)
    # Use Docker bridge gateway IP to reach services on host network from bridge network
    # On Linux, host.docker.internal may not work, so use 172.17.0.1 (default bridge gateway)
    emby:
      loadBalancer:
        servers:
          - url: "http://172.17.0.1:8096"

    # Portainer - Internal port 9000 (HTTP UI port)
    # Note: Portainer serves web UI on port 9000, not 8000
    portainer-100:
      loadBalancer:
        servers:
          - url: "http://portainer:9000"

  # Middlewares for security and rate limiting
  middlewares:
    emby-security-headers:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "no-referrer"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Service-Name: "emby"
    emby-rate-limit:
      rateLimit:
        average: 40
        burst: 60
