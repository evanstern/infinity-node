version: "3.8"

services:
  tailscale:
    image: tailscale/tailscale:stable
    container_name: tailscale
    network_mode: host
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ${TS_STATE_DIR_HOST:-/home/evan/config/tailscale}:/var/lib/tailscale
      - ${TS_TUN_DEVICE:-/dev/net/tun}:${TS_TUN_DEVICE:-/dev/net/tun}
    environment:
      TS_HOSTNAME: ${TS_HOSTNAME:-vm-100}
      TS_ROUTES: ${TS_ROUTES:-}
      TS_ACCEPT_DNS: ${TS_ACCEPT_DNS:-false}
      TS_EXIT_NODE: ${TS_EXIT_NODE:-false}
      TS_EXTRA_ARGS: ${TS_EXTRA_ARGS:-}
    secrets:
      - ts_authkey
    entrypoint: >
      /bin/sh -c '
        tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/var/run/tailscale/tailscaled.sock &
        for i in $(seq 1 30); do tailscale status >/dev/null 2>&1 && break; sleep 1; done
        AUTHKEY=$(cat /run/secrets/ts_authkey)
        ROUTES_ARG=""
        [ -n "$TS_ROUTES" ] && ROUTES_ARG="--advertise-routes=$TS_ROUTES"
        DNS_ARG="--accept-dns=$TS_ACCEPT_DNS"
        EXIT_ARG=""
        [ "$TS_EXIT_NODE" = "true" ] && EXIT_ARG="--advertise-exit-node"
        tailscale up --authkey="$AUTHKEY" --hostname="${TS_HOSTNAME:-vm-100}" $ROUTES_ARG $DNS_ARG $EXIT_ARG $TS_EXTRA_ARGS
        wait
      '
    restart: unless-stopped

secrets:
  ts_authkey:
    external: true
