name: downloads

services:
  # NordLynx VPN - All download traffic routes through this
  nordlynx:
    container_name: vpn
    image: ghcr.io/bubuntux/nordlynx:latest
    restart: unless-stopped

    cap_add:
      - NET_ADMIN  # Required for VPN tunnel
      - NET_RAW

    sysctls:
      - net.ipv4.conf.all.mtu=1420  # WireGuard optimal MTU

    dns:
      - 1.1.1.1  # Use Cloudflare DNS

    ports:
      # Deluge web UI
      - ${WEBUI_PORT:-8112}:8112
      # Torrent port (TCP and UDP)
      - ${TORRENT_PORT:-6881}:6881
      - ${TORRENT_PORT:-6881}:6881/udp
      # NZBGet web UI
      - ${NZBGET_PORT:-6789}:6789

    environment:
      - PRIVATE_KEY=${PRIVATE_KEY}  # NordVPN WireGuard private key (secret)
      - NET_LOCAL=${NET_LOCAL:-192.168.86.0/24}  # Local network CIDR

  # NZBGet - Usenet downloader
  nzbget:
    container_name: nzbget
    image: lscr.io/linuxserver/nzbget:latest
    restart: unless-stopped

    # Route all traffic through VPN (kill switch)
    network_mode: container:vpn

    # ports:
    #   - ${NZBGET_PORT:-6789}:6789

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Toronto}
      - NZBGET_USER=${NZBGET_USER}  # Web UI username (secret)
      - NZBGET_PASS=${NZBGET_PASS}  # Web UI password (secret)

    volumes:
      - ${NZBGET_CONFIG_PATH}:/config
      - ${INCOMPLETE_PATH}:/incomplete
      - ${COMPLETE_PATH}:/downloads

  # Deluge - Torrent client
  deluge:
    container_name: deluge
    image: ghcr.io/linuxserver/deluge:latest
    restart: unless-stopped

    # Route all traffic through VPN (kill switch)
    network_mode: service:nordlynx

    depends_on:
      nordlynx:
        condition: service_started
        restart: true

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Toronto}
      - DELUGE_LOGLEVEL=${DELUGE_LOGLEVEL:-error}

    volumes:
      - ${DELUGE_CONFIG_PATH}:/config
      - ${INCOMPLETE_PATH}:/incomplete
      - ${COMPLETE_PATH}:/complete
